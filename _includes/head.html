<head>
    <!-- CRITICAL: Initialize theme IMMEDIATELY - must be first thing in head -->
    <script>
        (function() {
            // Function to detect system theme preference
            function getSystemTheme() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                    return 'light';
                }
                return 'dark'; // Default fallback
            }
            
            // Get saved theme or detect from system
            let savedTheme = localStorage.getItem('theme');
            let currentTheme;
            
            if (savedTheme) {
                // User has explicitly set a preference
                currentTheme = savedTheme;
                console.log('Using saved theme preference:', currentTheme);
            } else {
                // First visit - detect from system
                currentTheme = getSystemTheme();
                console.log('First visit - detected system theme:', currentTheme);
                
                // Save the detected theme as user preference
                localStorage.setItem('theme', currentTheme);
                localStorage.setItem('theme-source', 'system-detected');
            }
            
            const html = document.documentElement;
            
            // Set theme attribute immediately
            html.setAttribute('data-theme', currentTheme);
            
            // Add CSS fallback classes for instant styling
            html.className = currentTheme === 'dark' ? 'theme-dark' : 'theme-light';
            
            // Update meta theme-color immediately
            const themeColor = currentTheme === 'dark' ? '#000000' : '#ffffff';
            html.style.setProperty('--meta-theme-color', themeColor);
            
            // Store initial theme for later sync
            window._initialTheme = currentTheme;
            
            // CRITICAL: Mark if this is a cached page load
            window._isCachedPageLoad = (performance.navigation?.type === 2) || 
                                     (performance.getEntriesByType?.('navigation')?.[0]?.type === 'back_forward');
            
            if (window._isCachedPageLoad) {
                console.log('Detected cached page load, will force theme toggle reinit');
            }
        })();
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="{{ site.theme_color | default: '#ffffff' }}" id="theme-color-meta">
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//unpkg.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    
    <!-- Preconnect to critical external domains -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

    <!-- Modern elegant font: Inter -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>

    <!-- Critical CSS (main theme styles) -->
    <link rel="preload" href="{{ site.baseurl }}/assets/css/app.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ site.baseurl }}/assets/css/app.css"></noscript>
    
    <!-- Favicon with multiple formats -->
    <link
        rel="shortcut icon"
        type="image/png"
        {% if site.favicon %}
            href="{{ site.favicon | relative_url }}"
        {% else %}
            href="{{ site.baseurl }}/favicon.png"
        {% endif %}
    >
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ site.baseurl }}/manifest.json">
    
    <!-- Apple PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BhargavAchary">
    <link rel="apple-touch-icon" href="{{ site.baseurl }}/images/avatar.jpg">
    
    <!-- Optimized Font Awesome loading -->
    <link
        rel="preload"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        as="style"
        onload="this.onload=null;this.rel='stylesheet'"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    >
    <noscript>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
            integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        >
    </noscript>
    
    <!-- Optimized social styles loading -->
    {% unless site.hide_share_buttons %}
        <link 
            rel="preload" 
            href="https://cdn.jsdelivr.net/npm/bulma-social@1/bin/bulma-social.min.css" 
            as="style" 
            onload="this.onload=null;this.rel='stylesheet'"
        >
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-social@1/bin/bulma-social.min.css"></noscript>
    {% endunless %}
    
    <!-- Defer non-critical JavaScript -->
    <script defer src="https://unpkg.com/alpinejs@3.9.0/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    
    {% seo %}
    {% include enhanced-meta.html %}
    {% include structured-data.html %}
    {% if site.feed %}
        {% feed_meta %}
    {% endif %}
    {%- if site.google_analytics -%}
        {%- include google-analytics.html -%}
    {%- endif -%}
    {%- include head-scripts.html -%}
</head>
