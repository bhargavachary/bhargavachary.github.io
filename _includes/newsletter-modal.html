{% comment %}
  Newsletter Signup Modal with Exit Intent
  Privacy-focused, GDPR compliant, smart display logic
{% endcomment %}

<div class="newsletter-modal" id="newsletter-modal" role="dialog" aria-labelledby="newsletter-title" aria-modal="true">
  <div class="newsletter-overlay" onclick="closeNewsletterModal()"></div>

  <div class="newsletter-container">
    <button class="newsletter-close" onclick="closeNewsletterModal()" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>

    <div class="newsletter-content">
      <div class="newsletter-icon">
        <i class="fas fa-envelope-open-text"></i>
      </div>

      <h2 id="newsletter-title" class="newsletter-title">
        Stay Updated! âœ¨
      </h2>

      <p class="newsletter-description">
        Stay in touch! When new content is posted, we might send you a notificationâ€”at most one email per month. No spam, ever.
      </p>

      <div class="newsletter-benefits">
        <div class="benefit-item">
          <i class="fas fa-check-circle"></i>
          <span>Optional notifications when new content is available</span>
        </div>
        <div class="benefit-item">
          <i class="fas fa-check-circle"></i>
          <span>Maximum one email per month</span>
        </div>
        <div class="benefit-item">
          <i class="fas fa-check-circle"></i>
          <span>No spam, unsubscribe anytime</span>
        </div>
      </div>

      {% comment %} Newsletter Form with Name and Email fields {% endcomment %}
      <form id="newsletter-form" class="newsletter-form">
        <div class="newsletter-input-group" style="flex-direction: column; gap: 1rem;">
          <input
            type="text"
            name="name"
            id="newsletter-name"
            class="newsletter-input"
            placeholder="Your name (optional)"
            aria-label="Name"
          />
          <div style="display: flex; gap: 0.5rem;">
            <input
              type="email"
              name="email"
              id="newsletter-email"
              class="newsletter-input"
              placeholder="Enter your email"
              required
              aria-label="Email address"
              style="flex: 1;"
            />
            <button type="submit" class="newsletter-submit" id="newsletter-submit-btn">
              <span class="submit-text">Subscribe</span>
              <span class="submit-icon">
                <i class="fas fa-paper-plane"></i>
              </span>
            </button>
          </div>
        </div>
      </form>

      <p class="newsletter-privacy">
        <i class="fas fa-lock"></i>
        We respect your privacy. Read our
        <a href="/privacy/" target="_blank">Privacy Policy</a>
      </p>

      <button class="newsletter-dismiss" onclick="dismissNewsletterForever()">
        <i class="fas fa-times-circle"></i>
        Don't show this again
      </button>
    </div>
  </div>
</div>

<script>
// Newsletter Modal with Exit Intent
(function() {
  'use strict';

  const config = {
    exitIntentSensitivity: 20,
    exitIntentDelay: 500,
    minTimeOnPage: 10000, // 10 seconds
    sessionKey: 'newsletter-shown-session',
    permanentKey: 'newsletter-dismissed-forever',
    subscribedKey: 'newsletter-subscribed'
  };

  let shown = false;
  let pageLoadTime = Date.now();

  function initNewsletter() {
    // Check if already dismissed forever
    if (localStorage.getItem(config.permanentKey) === 'true') {
      return;
    }

    // Check if already subscribed
    if (localStorage.getItem(config.subscribedKey) === 'true') {
      return;
    }

    // Check if shown in this session
    if (sessionStorage.getItem(config.sessionKey) === 'true') {
      return;
    }

    // Desktop: Exit intent detection
    if (window.innerWidth > 768) {
      document.addEventListener('mouseout', handleExitIntent);
    }
    // Mobile: Scroll-based trigger
    else {
      let lastScrollTop = 0;
      window.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Fast upward scroll (trying to leave)
        if (lastScrollTop - scrollTop > 100) {
          checkAndShow();
        }

        lastScrollTop = scrollTop;
      }, { passive: true });
    }

    // Form submission handling
    const form = document.getElementById('newsletter-form');
    if (form) {
      form.addEventListener('submit', handleSubscribe);
    }
  }

  function handleExitIntent(e) {
    const shouldShow = e.clientY < config.exitIntentSensitivity;

    if (shouldShow) {
      checkAndShow();
    }
  }

  function checkAndShow() {
    // Ensure minimum time on page
    if (Date.now() - pageLoadTime < config.minTimeOnPage) {
      return;
    }

    if (!shown) {
      showNewsletterModal();
      shown = true;
    }
  }

  window.showNewsletterModal = function() {
    const modal = document.getElementById('newsletter-modal');
    if (!modal) return;

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Mark as shown in session
    sessionStorage.setItem(config.sessionKey, 'true');

    // Track in analytics
    if (typeof gtag !== 'undefined') {
      gtag('event', 'newsletter_modal_shown', {
        'event_category': 'Newsletter',
        'event_label': 'Modal Shown'
      });
    }
  };

  window.closeNewsletterModal = function() {
    const modal = document.getElementById('newsletter-modal');
    if (!modal) return;

    modal.classList.remove('active');
    document.body.style.overflow = '';

    // Track dismissal
    if (typeof gtag !== 'undefined') {
      gtag('event', 'newsletter_modal_closed', {
        'event_category': 'Newsletter',
        'event_label': 'Modal Closed'
      });
    }
  };

  window.dismissNewsletterForever = function() {
    localStorage.setItem(config.permanentKey, 'true');
    closeNewsletterModal();

    // Track permanent dismissal
    if (typeof gtag !== 'undefined') {
      gtag('event', 'newsletter_dismissed_forever', {
        'event_category': 'Newsletter',
        'event_label': 'Dismissed Forever'
      });
    }
  };

  function handleSubscribe(e) {
    e.preventDefault(); // Prevent default form submission
    
    const form = e.target;
    const submitBtn = document.getElementById('newsletter-submit-btn');
    const originalText = submitBtn.innerHTML;
    
    // Get form data
    const name = document.getElementById('newsletter-name').value.trim();
    const email = document.getElementById('newsletter-email').value.trim();
    
    // Validate email
    if (!email) {
      alert('Please enter your email address.');
      return;
    }
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    submitBtn.disabled = true;
    
    // Prepare form data for Google Forms submission
    // REPLACE THESE PLACEHOLDER ENTRY IDs WITH YOUR ACTUAL ONES:
    // 1. Open your Google Form: https://docs.google.com/forms/d/e/1FAIpQLSd3m8QFkglw2aNQIvLtNmgsJi9fjqGuyztCCms_vud1vyJj5A/viewform
    // 2. Right-click on the Name field â†’ Inspect â†’ Find name="entry.XXXXXXXXXX"
    // 3. Right-click on the Email field â†’ Inspect â†’ Find name="entry.YYYYYYYYYY"
    // 4. Replace the entry IDs below
    const formData = new FormData();
    formData.append('entry.1234567890', name); // â† REPLACE: Your Name field entry ID
    formData.append('entry.0987654321', email); // â† REPLACE: Your Email field entry ID
    
    // Submit to Google Forms
    fetch('https://docs.google.com/forms/d/e/1FAIpQLSd3m8QFkglw2aNQIvLtNmgsJi9fjqGuyztCCms_vud1vyJj5A/formResponse', {
      method: 'POST',
      body: formData,
      mode: 'no-cors' // Required for cross-origin requests to Google Forms
    })
    .then(response => {
      // Google Forms doesn't return proper CORS headers, so we assume success
      // Mark as subscribed
      localStorage.setItem(config.subscribedKey, 'true');
      
      // Track subscription
      if (typeof gtag !== 'undefined') {
        gtag('event', 'newsletter_subscribe', {
          'event_category': 'Newsletter',
          'event_label': 'Subscribed'
        });
      }
      
      // Show success message
      showSuccessMessage();
      
      // Reset form
      form.reset();
    })
    .catch(error => {
      console.error('Subscription error:', error);
      alert('There was an error subscribing. Please try again or contact us directly.');
      
      // Reset button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
  }
  
  function showSuccessMessage() {
    const modal = document.getElementById('newsletter-modal');
    const modalContent = modal.querySelector('.newsletter-content');
    
    // Replace content with success message
    modalContent.innerHTML = `
      <div class="newsletter-icon" style="color: #10b981;">
        <i class="fas fa-check-circle"></i>
      </div>
      
      <h2 class="newsletter-title" style="color: #10b981;">
        Thank You! ðŸŽ‰
      </h2>
      
      <p class="newsletter-description">
        You've successfully subscribed to our newsletter! We'll keep you updated with new content and insights.
      </p>
      
      <div style="text-align: center; margin-top: 2rem;">
        <button class="newsletter-submit" onclick="closeNewsletterModal()" style="background: #10b981; border-color: #10b981;">
          <span class="submit-text">Continue Reading</span>
        </button>
      </div>
    `;
    
    // Auto-close after 5 seconds
    setTimeout(closeNewsletterModal, 5000);
  }

  // ESC key to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('newsletter-modal');
      if (modal && modal.classList.contains('active')) {
        closeNewsletterModal();
      }
    }
  });

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNewsletter);
  } else {
    initNewsletter();
  }
})();
</script>
